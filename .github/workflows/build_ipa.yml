name: Build iOS IPA

on:
  workflow_dispatch:

jobs:
  build:
    name: Build and (optionally) sign IPA
    runs-on: macos-latest
    env:
      PROJECT: "MagiCAM.xcodeproj"
      SCHEME: "MagiCAM"
      CONFIG: "Release"
      ARCHIVE_PATH: "${{ runner.workspace }}/build/MagiCAM.xcarchive"
      EXPORT_PATH: "${{ runner.workspace }}/build/export"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Xcode version
        run: xcodebuild -version || true

      - name: Prepare build directory
        run: mkdir -p build

      - name: Decode certificates and provisioning (if provided)
        if: ${{ secrets.CERTIFICATE_P12 && secrets.PROVISIONING_PROFILE }}
        run: |
          set -euo pipefail
          echo "$CERTIFICATE_P12" | base64 --decode > /tmp/cert.p12
          echo "$PROVISIONING_PROFILE" | base64 --decode > /tmp/profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
          echo "Certificates and provisioning profile written"
        env:
          CERTIFICATE_P12: ${{ secrets.CERTIFICATE_P12 }}
          PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}

      - name: Import certificate into keychain (if provided)
        if: ${{ secrets.CERTIFICATE_P12 }}
        run: |
          set -euo pipefail
          security create-keychain -p temp temp.keychain || true
          security default-keychain -s temp.keychain
          security unlock-keychain -p temp temp.keychain
          security import /tmp/cert.p12 -k ~/Library/Keychains/temp.keychain -P "$CERTIFICATE_PASSWORD" -A || true
          security set-key-partition-list -S apple-tool:,apple: -s -k temp temp.keychain || true
        env:
          CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}

      - name: Archive with xcodebuild (signed or unsigned)
        run: |
          set -euo pipefail
          xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration "$CONFIG" -archivePath "$ARCHIVE_PATH" clean archive

      - name: Export IPA (signed) if provisioning available
        if: ${{ secrets.PROVISIONING_PROFILE && secrets.TEAM_ID && secrets.BUNDLE_ID && secrets.PROVISIONING_PROFILE_NAME }}
        run: |
          set -euo pipefail
          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>${{ secrets.TEAM_ID }}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${{ secrets.BUNDLE_ID }}</key>
              <string>${{ secrets.PROVISIONING_PROFILE_NAME }}</string>
            </dict>
          </dict>
          </plist>
          EOF
          xcodebuild -exportArchive -archivePath "$ARCHIVE_PATH" -exportOptionsPlist exportOptions.plist -exportPath "$EXPORT_PATH"
          ls -la "$EXPORT_PATH"

      - name: Create unsigned IPA for AltStore (no signing)
        run: |
          set -euo pipefail
          UNSIGNED_ARCHIVE="${{ env.ARCHIVE_PATH }}-unsigned"
          xcodebuild -project "$PROJECT" -scheme "$SCHEME" -configuration "$CONFIG" -archivePath "$UNSIGNED_ARCHIVE" clean archive CODE_SIGNING_ALLOWED=NO
          APP_PATH="$UNSIGNED_ARCHIVE/Products/Applications/${SCHEME}.app"
          mkdir -p "$EXPORT_PATH"
          mkdir -p Payload
          if [ -d "$APP_PATH" ]; then
            cp -R "$APP_PATH" Payload/
            zip -r "${EXPORT_PATH}/${SCHEME}-unsigned.ipa" Payload >/dev/null
            rm -rf Payload
            echo "Unsigned IPA created: ${EXPORT_PATH}/${SCHEME}-unsigned.ipa"
          else
            echo "App bundle not found at $APP_PATH; cannot create unsigned IPA"
            ls -la "$UNSIGNED_ARCHIVE"
          fi

      - name: Upload IPA if produced
        uses: actions/upload-artifact@v4
        with:
          name: MagiCAM-artifacts
          path: |
            ${{ env.EXPORT_PATH }}/*.ipa
            ${{ env.ARCHIVE_PATH }}
            ${{ env.ARCHIVE_PATH }}-unsigned

      - name: Print build results
        run: |
          echo "Done. If IPA was created it is uploaded as artifact named MagiCAM-artifacts."

